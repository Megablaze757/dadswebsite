<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sash Window Configurator — Reports & PDF</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* General */
* { margin:0; padding:0; box-sizing:border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
body { background:#f5f7f9; color:#2c3e50; padding:18px; }
.container { max-width:1200px; margin:0 auto; background:white; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,.08); overflow:hidden; }

/* Top nav */
.navbar { background:#2c3e50; padding:12px 18px; color:white; border-radius:8px 8px 0 0; margin-bottom:12px; }
.nav-logo { display:flex; align-items:center; gap:10px; font-weight:700; font-size:18px; }

/* Layout */
.content { display:flex; gap:20px; padding:18px; align-items:flex-start; }
.configurator { flex:1; min-width:320px; background:#f9fafb; padding:18px; border-radius:8px; border:1px solid #eef2f5; }
.preview { width:360px; background:white; padding:18px; border-radius:8px; border:1px solid #eef2f5; }

/* Titles */
.section-title { font-size:16px; font-weight:700; color:#2c3e50; margin-bottom:10px; }

/* Form */
.form-group { margin-bottom:12px; }
label { display:block; font-weight:600; margin-bottom:6px; color:#2c3e50; }
select,input { width:100%; padding:9px 10px; border-radius:6px; border:1px solid #d7dde4; font-size:14px; background:white; }
.dimensions { display:grid; grid-template-columns:1fr 1fr; gap:8px; align-items:end; margin-bottom:8px; }
.info-text { color:#7f8c8d; font-size:13px; margin-top:6px; }

/* Buttons */
.btn { padding:10px 14px; border-radius:6px; border:none; cursor:pointer; font-weight:700; }
.calculate-btn { background:#3498db; color:white; width:100%; margin-top:6px; }
.calculate-btn:hover { background:#2980b9; }
.add-report-btn { background:#2ecc71; color:white; }
.clear-reports-btn { background:#e74c3c; color:white; }
.download-all-btn { background:#2b80d9; color:white; }

/* Preview */
.window-preview { width:100%; aspect-ratio:360/630; border:3px solid #2c3e50; border-radius:6px; overflow:hidden; display:flex; align-items:center; justify-content:center; background:#fff; margin-bottom:10px; }
.window-preview img { max-width:100%; max-height:100%; object-fit:contain; transition: transform .15s ease; transform-origin:center; }

/* Design grid */
.design-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(120px,1fr)); gap:10px; margin-bottom:10px; }
.design-item { background:white; padding:8px; border-radius:8px; border:2px solid #e8e8e8; cursor:pointer; text-align:center; transition: all .18s; }
.design-item:hover { transform:translateY(-4px); border-color:#3498db; box-shadow:0 8px 18px rgba(0,0,0,.06); }
.design-item.selected { border-color:#3498db; background:#e9f6ff; }
.design-preview { width:100px; height:175px; margin:0 auto 8px; overflow:hidden; border-radius:6px; background:linear-gradient(45deg,#f4f6f8,#fff); display:flex; align-items:center; justify-content:center; }
.design-preview img { width:100px; height:175px; object-fit:cover; display:block; }

/* Breakdown */
.breakdown { background:white; border:1px solid #eef2f5; padding:12px; border-radius:8px; margin-top:8px; }
.breakdown-item { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #f0f4f6; }
.breakdown-item:last-child { border-bottom:none; }

/* Reports */
.reports-section { margin:18px; padding:18px; background:#fff; border-radius:8px; border:1px solid #eef2f5; }
.report-controls { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
.reports-container { max-height:520px; overflow:auto; padding:8px; background:#f9fafb; border-radius:6px; border:1px solid #eef2f5; }
.report { display:flex; gap:12px; background:#fff; padding:12px; border-radius:8px; border:1px solid #e6ebef; margin-bottom:12px; align-items:flex-start; }
.report img { width:100px; height:175px; object-fit:cover; border-radius:6px; border:1px solid #ddd; }
.report-details { flex:1; }
.report-details h3 { margin-bottom:6px; font-size:16px; }
.report-details p { margin:4px 0; font-size:13px; color:#2c3e50; }
.report-actions { display:flex; gap:8px; margin-top:8px; }

/* Grand total */
.grand-total { margin-top:12px; padding:12px; background:#2c3e50; color:white; border-radius:8px; font-weight:700; text-align:right; }

/* Helper states */
input.invalid { border-color:#e74c3c !important; box-shadow:0 0 0 3px rgba(231,76,60,.08); }
input.valid { border-color:#27ae60 !important; box-shadow:0 0 0 3px rgba(39,174,96,.08); }
#sizeHelp { font-size:13px; color:#7f8c8d; }

/* Responsive */
@media (max-width:900px) {
  .content { flex-direction:column; }
  .preview { width:100%; }
  .window-preview { max-width:100%; height:420px; }
}
</style>
</head>
<body>
<div class="container">
  <div class="navbar">
    <div class="nav-logo"><i class="fas fa-window-restore"></i> Sash Window Configurator</div>
  </div>

  <div class="content">
    <!-- Left: configurator -->
    <div class="configurator">
      <div class="section-title">Choose your design</div>

      <div class="form-group">
        <div class="design-grid" id="designGrid">
          <!-- design items - ensure design1.png ... design12.png exist; placeholder used if not -->
          <div class="design-item selected" data-design="1" data-base-price="518.41" data-balance="weights" data-wood="pine" data-bars="none" data-preview="design1.png">
            <div class="design-preview"><img src="design1.png" alt="Design 1" onerror="this.src='placeholder.png'"></div>
            <div class="design-name">Design 1</div>
            <div class="design-price">£518.41</div>
          </div>
          <div class="design-item" data-design="2" data-base-price="522.34" data-balance="spring" data-wood="pine" data-bars="with-bars" data-preview="design2.png">
            <div class="design-preview"><img src="design2.png" alt="Design 2" onerror="this.src='placeholder.png'"></div>
            <div class="design-name">Design 2</div>
            <div class="design-price">£522.34</div>
          </div>
          <div class="design-item" data-design="3" data-base-price="740.32" data-balance="weights" data-wood="sapele" data-bars="with-bars" data-preview="design3.png">
            <div class="design-preview"><img src="design3.png" alt="Design 3" onerror="this.src='placeholder.png'"></div>
            <div class="design-name">Design 3</div>
            <div class="design-price">£740.32</div>
          </div>
          <div class="design-item" data-design="4" data-base-price="705.08" data-balance="weights" data-wood="pine" data-bars="with-bars" data-preview="design4.png">
            <div class="design-preview"><img src="design4.png" alt="Design 4" onerror="this.src='placeholder.png'"></div>
            <div class="design-name">Design 4</div>
            <div class="design-price">£705.08</div>
          </div>
          <div class="design-item" data-design="5" data-base-price="673.88" data-balance="weights" data-wood="pine" data-bars="with-bars" data-preview="design5.png">
            <div class="design-preview"><img src="design5.png" alt="Design 5" onerror="this.src='placeholder.png'"></div>
            <div class="design-name">Design 5</div>
            <div class="design-price">£673.88</div>
          </div>
          <div class="design-item" data-design="6" data-base-price="731.8" data-balance="weights" data-wood="pine" data-bars="with-bars" data-preview="design6.png">
            <div class="design-preview"><img src="design6.png" alt="Design 6" onerror="this.src='placeholder.png'"></div>
            <div class="design-name">Design 6</div>
            <div class="design-price">£731.80</div>
          </div>
          <div class="design-item" data-design="7" data-base-price="706.7" data-balance="weights" data-wood="pine" data-bars="with-bars" data-preview="design7.png">
            <div class="design-preview"><img src="design7.png" alt="Design 7" onerror="this.src='placeholder.png'"></div>
            <div class="design-name">Design 7</div>
            <div class="design-price">£706.70</div>
          </div>
          <div class="design-item" data-design="8" data-base-price="865.52" data-balance="weights" data-wood="pine" data-bars="with-bars" data-preview="design8.png">
            <div class="design-preview"><img src="design8.png" alt="Design 8" onerror="this.src='placeholder.png'"></div>
            <div class="design-name">Design 8</div>
            <div class="design-price">£865.52</div>
          </div>
          <!-- Design 9: disables sub-type dropdowns -->
          <div class="design-item" data-design="9" data-base-price="432.15" data-balance="fixed" data-wood="pine" data-bars="none" data-preview="design9.png">
            <div class="design-preview"><img src="design9.png" alt="Design 9" onerror="this.src='placeholder.png'"></div>
            <div class="design-name">Design 9</div>
            <div class="design-price">£432.15</div>
          </div>
          <div class="design-item" data-design="10" data-base-price="602.87" data-balance="weights" data-wood="pine" data-bars="none" data-preview="design10.png">
            <div class="design-preview"><img src="design10.png" alt="Design 10" onerror="this.src='placeholder.png'"></div>
            <div class="design-name">Design 10</div>
            <div class="design-price">£602.87</div>
          </div>
          <div class="design-item" data-design="11" data-base-price="1854.43" data-balance="weights" data-wood="pine" data-bars="none" data-preview="design11.png">
            <div class="design-preview"><img src="design11.png" alt="Design 11" onerror="this.src='placeholder.png'"></div>
            <div class="design-name">Design 11</div>
            <div class="design-price">£1854.43</div>
          </div>
          <div class="design-item" data-design="12" data-base-price="2084.46" data-balance="weights" data-wood="pine" data-bars="none" data-preview="design12.png">
            <div class="design-preview"><img src="design12.png" alt="Design 12" onerror="this.src='placeholder.png'"></div>
            <div class="design-name">Design 12</div>
            <div class="design-price">£2084.46</div>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="balance">Balance Type</label>
        <select id="balance">
          <option value="weights">Weights Balance</option>
          <option value="spring">Spring Balance</option>
          <option value="fixed">Fixed (No Opening)</option>
        </select>
      </div>

      <div class="form-group">
        <label for="wood">Wood Type</label>
        <select id="wood">
          <option value="pine">Engineered Pine with Sapele Sill</option>
          <option value="sapele">Full Hardwood Sapele</option>
        </select>
      </div>

      <div class="form-group">
        <label for="bars">Window Bars</label>
        <select id="bars">
          <option value="none">No Bars</option>
          <option value="with-bars">22mm Bars with Spacer</option>
        </select>
      </div>

      <div class="dimensions">
        <div>
          <label for="widthInput">Width (mm)</label>
          <input id="widthInput" type="number" min="100" max="3000" value="1000">
        </div>
        <div>
          <label for="heightInput">Height (mm)</label>
          <input id="heightInput" type="number" min="100" max="3000" value="1000">
        </div>
      </div>
      <div id="sizeHelp">Enter dimensions (max 2400mm).</div>

      <div class="form-group">
        <label for="quantity">Quantity</label>
        <input id="quantity" type="number" min="1" value="1">
        <p class="info-text">Bulk discounts available for orders over 5 units</p>
      </div>

      <button class="btn calculate-btn" id="calcBtn">CALCULATE PRICE</button>

      <div class="breakdown" aria-live="polite" style="margin-top:12px;">
        <div class="breakdown-item"><span>Base Design Price:</span><span id="break_base">£0.00</span></div>
        <div class="breakdown-item"><span>Size Adjustment:</span><span id="break_size">£0.00</span></div>
        <div class="breakdown-item"><span>Balance Type:</span><span id="break_balance">£0.00</span></div>
        <div class="breakdown-item"><span>Wood Type:</span><span id="break_wood">£0.00</span></div>
        <div class="breakdown-item"><span>Window Bars:</span><span id="break_bars">£0.00</span></div>
        <div class="breakdown-item"><span>Total per Unit:</span><span id="break_unit">£0.00</span></div>
        <div class="breakdown-item"><span>Quantity:</span><span id="break_qty">1</span></div>
        <div class="breakdown-item"><span>Total Price:</span><span id="break_total">£0.00</span></div>
      </div>
    </div>

    <!-- Right: preview -->
    <div class="preview">
      <div class="section-title">Window Preview</div>
      <div class="window-preview">
        <img id="preview-image" src="design1.png" alt="Preview" onerror="this.src='placeholder.png'" style="transform-origin:center;">
      </div>
      <div style="display:flex;gap:8px;justify-content:center;margin-bottom:8px;" class="preview-controls">
        <button class="btn" id="zoomInBtn"><i class="fas fa-search-plus"></i></button>
        <button class="btn" id="zoomOutBtn"><i class="fas fa-search-minus"></i></button>
        <button class="btn" id="resetZoomBtn"><i class="fas fa-sync"></i></button>
      </div>
      <div style="text-align:center;margin-top:6px;">
        <div style="font-size:13px;color:#7f8c8d;">Estimated Price</div>
        <div id="mainPrice" style="font-size:20px;font-weight:700;color:#2c3e50;margin-top:6px;">£0.00</div>
        <div id="errorMsg" style="margin-top:8px;font-size:13px;"></div>
      </div>
    </div>
  </div>

  <!-- Reports -->
  <div class="reports-section">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
      <div class="section-title">Your Reports</div>
      <div style="display:flex;gap:8px;">
        <button class="btn add-report-btn" id="addReportBtn"><i class="fas fa-plus"></i> Add Current Configuration to Report</button>
        <button class="btn clear-reports-btn" id="clearReportsBtn"><i class="fas fa-trash"></i> Clear All Reports</button>
        <button class="btn download-all-btn" id="downloadAllBtn"><i class="fas fa-file-download"></i> Download All Reports (PDF)</button>
      </div>
    </div>

    <div class="reports-container" id="reportsContainer">
      <div class="no-reports" id="noReportsMessage">No reports added yet. Configure a window and click "Add to Report" to create your first report.</div>
    </div>

    <div class="grand-total" id="grandTotal">Grand Total: £0.00</div>
  </div>
</div>

<script>
/* ============================
   Data + Helpers
   ============================ */
const featureCosts = {
  balance: { weights:0, spring:3.93, fixed:-86.26 },
  wood: { pine:0, sapele:221.91 },
  bars: { none:0, 'with-bars':213.39 }
};

let reports = [];
let grandTotal = 0;
let zoomLevel = 1;

function toInt(v) { return parseInt(v) || 0; }
function formatDate(d) {
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yyyy = d.getFullYear();
  return dd + '/' + mm + '/' + yyyy;
}

/* ============================
   Validation and UI helpers
   ============================ */
function validateSize(design, width, height) {
  if (width > 2400 || height > 2400) return "Width and height cannot exceed 2400mm.";
  if (design >=1 && design <=10) {
    if (width < 500 || width > 1400 || height < 1000 || height > 2500) return "Designs 1–10 require width 500–1400mm and height 1000–2500mm.";
    return "";
  }
  if (design === 11) {
    if (width < 1500 || width > 2400 || height < 1500 || height > 2400) return "Design 11 requires width 1500–2400mm and height 1500–2400mm.";
    return "";
  }
  if (design === 12) {
    if (width < 1500 || width > 2400 || height < 1500 || height > 2400) return "Design 12 requires width 1500–2400mm and height 1500–2400mm.";
    return "";
  }
  return "";
}

function updateSizeHelp(design) {
  const el = document.getElementById('sizeHelp');
  if (!el) return;
  if (design >=1 && design <=10) el.textContent = "Designs 1–10: width 500–1400mm, height 1000–2500mm.";
  else if (design === 11) el.textContent = "Design 11: width 1500–2400mm, height 1500–2400mm.";
  else if (design === 12) el.textContent = "Design 12: width 1500–2400mm, height 1500–2400mm.";
  else el.textContent = "Enter dimensions (max 2400mm).";
}

/* Toggle sub-option availability for design 9 (disable all subtypes as requested) */
function toggleOptionsForDesign(design) {
  const balance = document.getElementById('balance');
  const wood = document.getElementById('wood');
  const bars = document.getElementById('bars');

  if (!balance || !wood || !bars) return;

  if (design === 9) {
    balance.disabled = true;
    wood.disabled = true;
    bars.disabled = true;
    balance.value = 'fixed';
    wood.value = 'pine';
    bars.value = 'none';
  } else {
    balance.disabled = false;
    wood.disabled = false;
    bars.disabled = false;
  }
}

/* Balance / wood / bars readable text */
function getBalanceTypeText(v) {
  const map = { weights:'Traditional 147mm sash box with weights balance', spring:'Spring balance', fixed:'Fixed (No Opening)' };
  return map[v] || v;
}
function getWoodTypeText(v) {
  const map = { pine:'Engineered core wood PINE with hardwood SAPELE sill', sapele:'Full Hardwood SAPELE' };
  return map[v] || v;
}
function getBarsText(v) {
  const map = { none:'Not requested / no groove', 'with-bars':'22mm bars with spacer' };
  return map[v] || v;
}

/* ============================
   Calculation & Breakdown
   ============================ */
function calculatePrice() {
  const selected = document.querySelector('.design-item.selected');
  const err = document.getElementById('errorMsg');
  const widthEl = document.getElementById('widthInput');
  const heightEl = document.getElementById('heightInput');
  const qtyEl = document.getElementById('quantity');
  const mainPriceEl = document.getElementById('mainPrice');

  if (!selected) return null;
  const designId = toInt(selected.dataset.design);
  const basePrice = parseFloat(selected.dataset.basePrice) || 0;
  const width = toInt(widthEl.value);
  const height = toInt(heightEl.value);
  const qty = Math.max(1, toInt(qtyEl.value));

  const validationError = validateSize(designId, width, height);
  if (validationError) {
    err.textContent = validationError;
    err.style.color = '#a94442';
    widthEl.classList.add('invalid'); heightEl.classList.add('invalid');
    document.getElementById('break_base').textContent = '£0.00';
    document.getElementById('break_size').textContent = '£0.00';
    document.getElementById('break_balance').textContent = '£0.00';
    document.getElementById('break_wood').textContent = '£0.00';
    document.getElementById('break_bars').textContent = '£0.00';
    document.getElementById('break_unit').textContent = '£0.00';
    document.getElementById('break_qty').textContent = qty;
    document.getElementById('break_total').textContent = '£0.00';
    mainPriceEl.textContent = '£0.00';
    toggleOptionsForDesign(designId);
    return null;
  }

  // valid
  err.textContent = '✅ Size OK';
  err.style.color = '#2c7a34';
  widthEl.classList.remove('invalid'); heightEl.classList.remove('invalid');

  toggleOptionsForDesign(designId);

  const area = width * height;
  const ref = 1000000;
  const sizeFactor = Math.pow(area / ref, 0.8);

  const balanceVal = document.getElementById('balance').value;
  const woodVal = document.getElementById('wood').value;
  const barsVal = document.getElementById('bars').value;

  const balanceAdj = featureCosts.balance[balanceVal] || 0;
  const woodAdj = featureCosts.wood[woodVal] || 0;
  const barsAdj = featureCosts.bars[barsVal] || 0;

  const adjustedPrice = (basePrice + balanceAdj + woodAdj + barsAdj) * sizeFactor;
  const totalPrice = adjustedPrice * qty * 1.3; // VAT / multiplier retained

  document.getElementById('break_base').textContent = '£' + basePrice.toFixed(2);
  document.getElementById('break_size').textContent = ((sizeFactor>1)?'+':'') + ((sizeFactor-1)*100).toFixed(1) + '%';
  document.getElementById('break_balance').textContent = (balanceAdj !== 0) ? '£' + balanceAdj.toFixed(2) : '£0.00';
  document.getElementById('break_wood').textContent = (woodAdj !== 0) ? '£' + woodAdj.toFixed(2) : '£0.00';
  document.getElementById('break_bars').textContent = (barsAdj !== 0) ? '£' + barsAdj.toFixed(2) : '£0.00';
  document.getElementById('break_unit').textContent = '£' + adjustedPrice.toFixed(2);
  document.getElementById('break_qty').textContent = qty;
  document.getElementById('break_total').textContent = '£' + totalPrice.toFixed(2);

  mainPriceEl.textContent = '£' + totalPrice.toFixed(2);

  return {
    designId, width, height, qty,
    balanceVal, woodVal, barsVal,
    basePrice, adjustedPrice, totalPrice
  };
}

/* ============================
   Reports (add / delete / render)
   ============================ */
function addReport() {
  const calc = calculatePrice();
  if (!calc) {
    alert('Please fix validation errors before adding to report.');
    return;
  }
  const selected = document.querySelector('.design-item.selected');
  const designName = (selected && selected.querySelector('.design-name')) ? selected.querySelector('.design-name').textContent : ('Design ' + calc.designId);
  const preview = (selected && selected.dataset && selected.dataset.preview) ? selected.dataset.preview : 'placeholder.png';

  const report = {
    id: Date.now(),
    designId: calc.designId,
    designName,
    imageUrl: preview,
    width: calc.width,
    height: calc.height,
    quantity: calc.qty,
    balanceType: calc.balanceVal,
    woodType: calc.woodVal,
    bars: calc.barsVal,
    unitPrice: calc.adjustedPrice,
    totalPrice: calc.totalPrice
  };

  reports.push(report);
  recalcGrandTotal();
  renderReports();
  // scroll to reports
  document.querySelector('.reports-section').scrollIntoView({behavior:'smooth'});
}

function recalcGrandTotal(){
  grandTotal = reports.reduce((sum, r) => sum + (r.totalPrice || 0), 0);
  document.getElementById('grandTotal').textContent = 'Grand Total: £' + grandTotal.toFixed(2);
}

function deleteReport(id) {
  const idx = reports.findIndex(r => r.id === id);
  if (idx === -1) return;
  if (!confirm('Delete this report?')) return;
  reports.splice(idx,1);
  recalcGrandTotal();
  renderReports();
}

function clearReports() {
  if (reports.length === 0) return;
  if (!confirm('Clear all reports?')) return;
  reports = [];
  recalcGrandTotal();
  renderReports();
}

function renderReports() {
  const container = document.getElementById('reportsContainer');
  const noMsg = document.getElementById('noReportsMessage');
  container.innerHTML = '';
  if (reports.length === 0) {
    noMsg.style.display = 'block';
    return;
  }
  noMsg.style.display = 'none';
  reports.forEach(r => {
    const div = document.createElement('div');
    div.className = 'report';
    div.id = 'report-' + r.id;
    div.innerHTML = `
      <img src="${r.imageUrl}" alt="Design image" onerror="this.src='placeholder.png'">
      <div class="report-details">
        <h3>${r.designName}</h3>
        <p><strong>Size:</strong> ${r.width} mm x ${r.height} mm</p>
        <p><strong>Quantity:</strong> ${r.quantity}</p>
        <p><strong>Unit Price:</strong> £${r.unitPrice.toFixed(2)}</p>
        <p class="total-price"><strong>Total:</strong> £${r.totalPrice.toFixed(2)}</p>
        <p><strong>Profile:</strong> ${getBalanceTypeText(r.balanceType)}</p>
        <p><strong>Timber:</strong> ${getWoodTypeText(r.woodType)}</p>
        <p><strong>Finish:</strong> Internal/External RAL9016 White</p>
        <p><strong>Glass:</strong> 4mm / 12 argon / 4mm Low-E / 1.1W/m2K</p>
        <p><strong>Bars:</strong> ${getBarsText(r.bars)}</p>
        <p><strong>Ironmongery:</strong> Lockable fastener, sash lifts & pulleys</p>
        <p><strong>Sill:</strong> Flush hardwood SAPELE</p>
        <p><strong>Board:</strong> Not requested / no groove</p>
        <p><strong>Ventilation:</strong> Not requested</p>
        <div class="report-actions">
          <button class="btn" onclick="downloadSingleReportPDF(${r.id})" style="background:#2b80d9;color:white;"><i class="fas fa-file-pdf"></i> Download PDF</button>
          <button class="btn" style="background:#e74c3c;color:white;" onclick="deleteReport(${r.id})"><i class="fas fa-trash"></i> Remove</button>
        </div>
      </div>
    `;
    container.appendChild(div);
  });
  // update grand total display
  document.getElementById('grandTotal').textContent = 'Grand Total: £' + grandTotal.toFixed(2);
}

/* ============================
   PDF generation via print window (self-contained)
   - Single report: one page
   - All reports: multiple pages + summary
   ============================ */
function openPrintWindow(htmlContent) {
  const w = window.open('', '_blank', 'toolbar=0,location=0,menubar=0');
  if (!w) { alert('Popup blocked. Allow popups for this site to download PDFs.'); return; }
  const style = `
    <style>
      body{font-family:Arial,Helvetica,sans-serif;color:#222;margin:24px;}
      .header{text-align:center;margin-bottom:8px}
      .header h1{margin:0;font-size:20px}
      .meta{text-align:center;color:#666;margin-bottom:12px}
      .report-page{page-break-after:always}
      .report-block{display:flex;gap:12px;margin-bottom:6px}
      .report-block img{width:150px;height:260px;object-fit:cover;border:1px solid #ddd}
      .specs h2{margin:0 0 8px 0;font-size:18px}
      .specs p{margin:6px 0}
      table{width:100%;border-collapse:collapse;margin-top:10px}
      table th, table td{border:1px solid #ccc;padding:6px 8px;text-align:left}
      .summary{margin-top:12px;font-weight:bold;text-align:right}
    </style>
  `;
  w.document.open();
  w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Reports</title>${style}</head><body>${htmlContent}</body></html>`);
  w.document.close();
  w.onload = function(){ setTimeout(()=>{ w.focus(); w.print(); }, 300); };
}

function buildSingleReportHTML(report) {
  const dateStr = formatDate(new Date());
  return `
    <div class="report-page">
      <div class="header"><h1>Sash Window Configurator</h1></div>
      <div class="meta">Date: ${dateStr}</div>
      <div class="report-block">
        <img src="${report.imageUrl}" onerror="this.src='placeholder.png'">
        <div class="specs">
          <h2>${escapeHtml(report.designName)}</h2>
          <p><strong>Size:</strong> ${report.width} mm x ${report.height} mm</p>
          <p><strong>Quantity:</strong> ${report.quantity}</p>
          <p><strong>Unit Price:</strong> £${report.unitPrice.toFixed(2)}</p>
          <p><strong>Total Price:</strong> £${report.totalPrice.toFixed(2)}</p>
          <p><strong>Profile:</strong> ${escapeHtml(getBalanceTypeText(report.balanceType))}</p>
          <p><strong>Timber:</strong> ${escapeHtml(getWoodTypeText(report.woodType))}</p>
          <p><strong>Finish:</strong> Internal/External RAL9016 White</p>
          <p><strong>Glass:</strong> 4mm / 12 argon / 4mm Low-E / 1.1W/m2K</p>
          <p><strong>Bars:</strong> ${escapeHtml(getBarsText(report.bars))}</p>
          <p><strong>Ironmongery:</strong> Lockable fastener, sash lifts & pulleys</p>
          <p><strong>Sill:</strong> Flush hardwood SAPELE</p>
          <p><strong>Board:</strong> Not requested / no groove</p>
          <p><strong>Ventilation:</strong> Not requested</p>
        </div>
      </div>
    </div>
  `;
}

function buildAllReportsHTML() {
  if (reports.length === 0) return '';
  let pages = '';
  reports.forEach(r => pages += buildSingleReportHTML(r));
  // build summary table
  let rows = '';
  reports.forEach((r,i) => {
    rows += `<tr>
      <td>${i+1}</td>
      <td>${escapeHtml(r.designName)}</td>
      <td>${r.width} x ${r.height}</td>
      <td>${r.quantity}</td>
      <td>£${r.unitPrice.toFixed(2)}</td>
      <td>£${r.totalPrice.toFixed(2)}</td>
    </tr>`;
  });
  rows += `<tr style="font-weight:bold;">
    <td colspan="5" style="text-align:right">Grand Total</td><td>£${grandTotal.toFixed(2)}</td>
  </tr>`;
  const summary = `
    <div class="report-page">
      <div class="header"><h1>Sash Window Configurator — Quote Summary</h1></div>
      <div class="meta">Date: ${formatDate(new Date())}</div>
      <table><thead><tr><th>#</th><th>Design</th><th>Size (W x H)</th><th>Qty</th><th>Unit Price</th><th>Total</th></tr></thead>
      <tbody>
        ${rows}
      </tbody></table>
      <div class="summary">Grand Total: £${grandTotal.toFixed(2)}</div>
    </div>
  `;
  return pages + summary;
}

function downloadSingleReportPDF(reportId) {
  const rep = reports.find(r => r.id === reportId);
  if (!rep) { alert('Report not found'); return; }
  const html = buildSingleReportHTML(rep);
  openPrintWindow(html);
}

function downloadAllReportsPDF() {
  if (reports.length === 0) { alert('No reports to export'); return; }
  const html = buildAllReportsHTML();
  openPrintWindow(html);
}

function escapeHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* ============================
   Zoom controls
   ============================ */
function updateImageZoom() {
  const img = document.getElementById('preview-image');
  img.style.transform = `scale(${zoomLevel})`;
}

/* ============================
   Wiring events on DOM load
   ============================ */
document.addEventListener('DOMContentLoaded', function() {
  // initial
  renderReports();

  // design click behavior
  document.querySelectorAll('.design-item').forEach(item => {
    item.addEventListener('click', function(){
      document.querySelectorAll('.design-item').forEach(i=>i.classList.remove('selected'));
      this.classList.add('selected');
      const designId = toInt(this.dataset.design);
      const bal = this.dataset.balance;
      const br = this.dataset.bars;
      const wd = this.dataset.wood;
      // apply dropdown values (but design 9 will later disable them)
      if (document.getElementById('balance')) document.getElementById('balance').value = bal || 'weights';
      if (document.getElementById('bars')) document.getElementById('bars').value = br || 'none';
      // only set wood if provided (and allow toggle disabled by toggleOptionsForDesign)
      if (wd) document.getElementById('wood').value = wd;
      // preview
      const preview = this.dataset.preview || 'placeholder.png';
      const img = document.getElementById('preview-image'); img.src = preview;
      // reset zoom
      zoomLevel = 1; updateImageZoom();
      // update help & toggle options
      updateSizeHelp(designId);
      toggleOptionsForDesign(designId);
      // recalc
      calculatePrice();
    });
  });

  // inputs
  ['widthInput','heightInput','quantity'].forEach(id=>{
    const el = document.getElementById(id); if(!el) return;
    el.addEventListener('input', calculatePrice);
  });
  ['balance','wood','bars'].forEach(id=>{
    const el = document.getElementById(id); if(!el) return;
    el.addEventListener('change', calculatePrice);
  });

  // buttons
  document.getElementById('calcBtn').addEventListener('click', (e)=>{ e.preventDefault(); calculatePrice(); });
  document.getElementById('addReportBtn').addEventListener('click', addReport);
  document.getElementById('clearReportsBtn').addEventListener('click', clearReports);
  document.getElementById('downloadAllBtn').addEventListener('click', downloadAllReportsPDF);

  // zoom
  document.getElementById('zoomInBtn').addEventListener('click', ()=>{ zoomLevel = Math.min(2, zoomLevel + 0.1); updateImageZoom(); });
  document.getElementById('zoomOutBtn').addEventListener('click', ()=>{ zoomLevel = Math.max(0.5, zoomLevel - 0.1); updateImageZoom(); });
  document.getElementById('resetZoomBtn').addEventListener('click', ()=>{ zoomLevel = 1; updateImageZoom(); });

  // set initial preview and recalc
  const initial = document.querySelector('.design-item.selected') || document.querySelector('.design-item');
  if (initial) {
    const p = initial.dataset.preview || 'placeholder.png';
    document.getElementById('preview-image').src = p;
    updateSizeHelp(toInt(initial.dataset.design));
    toggleOptionsForDesign(toInt(initial.dataset.design));
  }
  calculatePrice();
});
</script>
</body>
</html>
