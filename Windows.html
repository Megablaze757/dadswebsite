<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sash Window Configurator — Rebuilt</title>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* ========== FULL CSS (mirror styling you approved) ========== */
/* Kept organized and readable with responsive rules */

/* Base */
* { margin:0; padding:0; box-sizing:border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
body { background-color:#f5f7f9; color:#2c3e50; line-height:1.6; padding:20px; min-height:100vh; }

/* Nav */
.navbar { 
  background-color: #2c3e50; 
  padding: 0 20px; 
  border-radius: 10px 10px 0 0;
  margin-bottom: 20px;
  box-shadow: 0 2px 10px rgba(0,0,0,.1);
}
.nav-container { max-width: 1200px; margin: 0 auto; display:flex; justify-content:space-between; align-items:center; height:70px; }
.nav-logo { color:white; font-size:24px; font-weight:bold; display:flex; align-items:center; gap:10px; }
.nav-menu { display:flex; list-style:none; gap:10px; }
.nav-link { color:white; text-decoration:none; padding:10px 12px; border-radius:6px; }
.nav-link:hover, .nav-link.active { background:#3498db; }
.hamburger { display:none; color:white; font-size:22px; cursor:pointer; }

/* Container */
.container { max-width:1200px; margin:0 auto; background:white; border-radius:0 0 10px 10px; box-shadow:0 5px 20px rgba(0,0,0,.1); overflow:hidden; }
header { background:#2c3e50; color:white; padding:20px; text-align:center; }
.content { display:flex; flex-wrap:wrap; gap:18px; padding:18px; }

/* Left configurator */
.configurator { flex:1; min-width:320px; padding:18px; background:#f9fafb; border-right:1px solid #eaecee; border-radius:8px; }
.section-title { font-size:18px; font-weight:600; color:#2c3e50; margin-bottom:12px; padding-bottom:6px; border-bottom:2px solid #eaecee; }
.form-group { margin-bottom:14px; }
label { display:block; margin-bottom:8px; font-weight:600; color:#2c3e50; }
select,input { width:100%; padding:10px 12px; border:1px solid #d1d8e0; border-radius:6px; background:white; font-size:14px; transition: all .18s; }
select:focus,input:focus { outline:none; border-color:#3498db; box-shadow:0 0 0 3px rgba(52,152,219,.12); }

/* Dimensions grid */
.dimensions { display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:end; }
#sizeHelp { grid-column:1 / -1; font-size:13px; color:#7f8c8d; margin-top:6px; }

/* Buttons */
.btn { padding:10px 14px; border-radius:6px; border:none; cursor:pointer; font-weight:600; }
.calculate-btn { background:#3498db; color:white; width:100%; margin-top:6px; }
.calculate-btn:hover { background:#2980b9; }
.add-report-btn { background:#2ecc71; color:white; }
.clear-reports-btn { background:#e74c3c; color:white; }
.download-all-btn { background:#2b80d9; color:white; }

/* Preview (right column) */
/* Default preview for designs 1-10 */
.window-preview { width:320px; height:240px; background:#8fb0bf; border:3px solid #2c3e50; border-radius:5px; margin:10px 0 16px 0; display:flex; align-items:center; justify-content:center; overflow:hidden; box-shadow:0 5px 12px rgba(0,0,0,.08); transition: all .28s ease; }
.window-preview img { width:100%; height:100%; object-fit:contain; transform-origin:center; transition: transform .12s ease; }

/* Design grid thumbnails (100x175) */
.design-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(140px, 1fr)); gap:12px; margin-top:12px; }
.design-item { background:white; border:2px solid #e8e8e8; border-radius:8px; padding:10px; text-align:center; cursor:pointer; transition: all .18s; }
.design-item:hover { transform:translateY(-4px); border-color:#3498db; box-shadow:0 5px 15px rgba(0,0,0,.06); }
.design-item.selected { border-color:#3498db; background:#e1f0fa; }
.design-preview { width:100px; height:175px; margin:0 auto 8px; overflow:hidden; border-radius:4px; background:linear-gradient(45deg,#f6f7f9,#ffffff); display:flex; align-items:center; justify-content:center; }
.design-preview img { width:100px; height:175px; object-fit:cover; display:block; }

/* Breakdown */
.breakdown { margin-top:14px; background:white; padding:12px; border-radius:8px; border:1px solid #eaecee; }
.breakdown-item { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee; }
.breakdown-total { font-weight:bold; border-top:2px solid #eee; margin-top:6px; padding-top:10px; }

/* Reports */
.reports-section { margin-top:24px; padding:18px; border-top:1px solid #eaecee; border-radius:8px; background:white; }
.report-controls { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
.reports-container { max-height:520px; overflow-y:auto; border:1px solid #eaecee; padding:12px; border-radius:8px; background:#f9fafb; }
.report { display:flex; gap:12px; background:white; padding:12px; border-radius:8px; border:1px solid #e6ebef; margin-bottom:12px; align-items:flex-start; }
.report img { width:100px; height:175px; object-fit:cover; border-radius:6px; border:1px solid #ddd; }
.report-details { flex:1; }
.report-details h3 { margin-bottom:6px; font-size:16px; }
.report-details p { margin:3px 0; font-size:14px; }
.report-actions { display:flex; gap:8px; margin-top:8px; }
.no-reports { text-align:center; padding:30px; color:#7f8c8d; font-style:italic; }

/* Grand total */
.grand-total { margin-top:12px; padding:12px; background:#2c3e50; color:white; border-radius:8px; font-weight:700; text-align:right; }

/* helper states */
input.invalid { border-color:#e74c3c !important; box-shadow:0 0 0 3px rgba(231,76,60,.08); }
input.valid { border-color:#27ae60 !important; box-shadow:0 0 0 3px rgba(39,174,96,.08); }

/* responsive */
@media (max-width:900px) {
  .content { flex-direction:column; }
  .window-preview { max-width:100%; }
  .nav-menu { position:fixed; left:-100%; top:70px; background:#2c3e50; width:100%; flex-direction:column; padding:20px 0; }
  .nav-menu.active { left:0; }
  .hamburger { display:block; }
  .reports-container { max-height:300px; }
}
</style>
</head>

<body>
<!-- Navigation -->
<nav class="navbar">
  <div class="nav-container">
    <div class="nav-logo"><i class="fas fa-window-restore"></i> Sash Windows</div>
    <ul class="nav-menu">
      <li><a class="nav-link active" href="#">Home</a></li>
      <li><a class="nav-link" href="#">Projects</a></li>
      <li><a class="nav-link" href="#">Testimonials</a></li>
    </ul>
    <div class="hamburger"><i class="fas fa-bars"></i></div>
  </div>
</nav>

<!-- Main -->
<div class="container">
  <header><h1>Sash Window Configurator</h1></header>

  <div class="content">
    <!-- LEFT: Configurator -->
    <div class="configurator">
      <h2 class="section-title">Device & Design of Your Setup Windows</h2>

      <!-- DESIGNS GRID -->
      <div class="form-group">
        <label>Select Design</label>
        <div class="design-grid" id="designGrid">
          <!-- 12 design items. Thumbnails (100x175). Use design1.png ... design12.png -->
          <div class="design-item selected" data-design="1" data-base-price="518.41" data-balance="weights" data-wood="pine" data-bars="none" data-preview="design1.png">
            <div class="design-preview"><img src="design1.png" alt="Design 1" onerror="this.src='placeholder.png'"></div>
            <div class="design-name">Design 1</div>
            <div class="design-price">£518.41</div>
          </div>
          <div class="design-item" data-design="2" data-base-price="522.34" data-balance="spring" data-wood="pine" data-bars="with-bars" data-preview="design2.png">
            <div class="design-preview"><img src="design2.png" alt="Design 2" onerror="this.src='placeholder.png'"></div>
            <div class="design-name">Design 2</div>
            <div class="design-price">£522.34</div>
          </div>
          <div class="design-item" data-design="3" data-base-price="740.32" data-balance="weights" data-wood="sapele" data-bars="with-bars" data-preview="design3.png">
            <div class="design-preview"><img src="design3.png" alt="Design 3" onerror="this.src='placeholder.png'"></div>
            <div class="design-name">Design 3</div>
            <div class="design-price">£740.32</div>
          </div>
          <div class="design-item" data-design="4" data-base-price="705.08" data-balance="weights" data-wood="pine" data-bars="with-bars" data-preview="design4.png">
            <div class="design-preview"><img src="design4.png" alt="Design 4" onerror="this.src='placeholder.png'"></div>
            <div class="design-name">Design 4</div>
            <div class="design-price">£705.08</div>
          </div>
          <div class="design-item" data-design="5" data-base-price="673.88" data-balance="weights" data-wood="pine" data-bars="with-bars" data-preview="design5.png">
            <div class="design-preview"><img src="design5.png" alt="Design 5" onerror="this.src='placeholder.png'"></div>
            <div class="design-name">Design 5</div>
            <div class="design-price">£673.88</div>
          </div>
          <div class="design-item" data-design="6" data-base-price="731.80" data-balance="weights" data-wood="pine" data-bars="with-bars" data-preview="design6.png">
            <div class="design-preview"><img src="design6.png" alt="Design 6" onerror="this.src='placeholder.png'"></div>
            <div class="design-name">Design 6</div>
            <div class="design-price">£731.80</div>
          </div>
          <div class="design-item" data-design="7" data-base-price="706.70" data-balance="weights" data-wood="pine" data-bars="with-bars" data-preview="design7.png">
            <div class="design-preview"><img src="design7.png" alt="Design 7" onerror="this.src='placeholder.png'"></div>
            <div class="design-name">Design 7</div>
            <div class="design-price">£706.70</div>
          </div>
          <div class="design-item" data-design="8" data-base-price="865.52" data-balance="weights" data-wood="pine" data-bars="with-bars" data-preview="design8.png">
            <div class="design-preview"><img src="design8.png" alt="Design 8" onerror="this.src='placeholder.png'"></div>
            <div class="design-name">Design 8</div>
            <div class="design-price">£865.52</div>
          </div>

          <!-- Design 9: fixed behaviour -->
          <div class="design-item" data-design="9" data-base-price="432.15" data-balance="fixed" data-wood="pine" data-bars="none" data-preview="design9.png">
            <div class="design-preview"><img src="design9.png" alt="Design 9" onerror="this.src='placeholder.png'"></div>
            <div class="design-name">Design 9</div>
            <div class="design-price">£432.15</div>
          </div>

          <div class="design-item" data-design="10" data-base-price="602.87" data-balance="weights" data-wood="pine" data-bars="none" data-preview="design10.png">
            <div class="design-preview"><img src="design10.png" alt="Design 10" onerror="this.src='placeholder.png'"></div>
            <div class="design-name">Design 10</div>
            <div class="design-price">£602.87</div>
          </div>

          <!-- Designs 11 & 12 are larger images (200x175) but use 100x175 thumbnails -->
          <div class="design-item" data-design="11" data-base-price="1854.43" data-balance="weights" data-wood="pine" data-bars="none" data-preview="design11.png">
            <div class="design-preview"><img src="design11.png" alt="Design 11" onerror="this.src='placeholder.png'"></div>
            <div class="design-name">Design 11</div>
            <div class="design-price">£1854.43</div>
          </div>

          <div class="design-item" data-design="12" data-base-price="2084.46" data-balance="weights" data-wood="pine" data-bars="none" data-preview="design12.png">
            <div class="design-preview"><img src="design12.png" alt="Design 12" onerror="this.src='placeholder.png'"></div>
            <div class="design-name">Design 12</div>
            <div class="design-price">£2084.46</div>
          </div>
        </div>
      </div>

      <!-- Sub-options -->
      <div class="form-group">
        <label for="balance">Balance Type:</label>
        <select id="balance">
          <option value="weights">Weights Balance</option>
          <option value="spring">Spring Balance</option>
          <option value="fixed">Fixed (No Opening)</option>
        </select>
      </div>

      <div class="form-group">
        <label for="wood">Wood Type:</label>
        <select id="wood">
          <option value="pine">Engineered Pine with Sapele Sill</option>
          <option value="sapele">Full Hardwood Sapele</option>
        </select>
      </div>

      <div class="form-group">
        <label for="bars">Window Bars:</label>
        <select id="bars">
          <option value="none">No Bars</option>
          <option value="with-bars">22mm Bars with Spacer</option>
        </select>
      </div>

      <!-- Dimensions -->
      <div class="dimensions">
        <div>
          <label for="width">Width (mm)</label>
          <input id="width" type="number" min="100" max="3000" value="1000">
        </div>
        <div>
          <label for="height">Height (mm)</label>
          <input id="height" type="number" min="100" max="3000" value="1000">
        </div>
        <div id="sizeHelp" class="default">Enter dimensions (max 2400mm).</div>
      </div>

      <div class="form-group">
        <label for="quantity">Quantity</label>
        <input id="quantity" type="number" min="1" value="1">
        <p class="info-text">Bulk discounts available for orders over 5 units</p>
      </div>

      <button class="btn calculate-btn" id="calcBtn">CALCULATE PRICE</button>

      <!-- Price breakdown -->
      <div class="breakdown" aria-live="polite">
        <h3>Price Breakdown</h3>
        <div class="breakdown-item"><span>Base Design Price:</span><span id="break_base">£0.00</span></div>
        <div class="breakdown-item"><span>Size Adjustment:</span><span id="break_size">£0.00</span></div>
        <div class="breakdown-item"><span>Balance Type:</span><span id="break_balance">£0.00</span></div>
        <div class="breakdown-item"><span>Wood Type:</span><span id="break_wood">£0.00</span></div>
        <div class="breakdown-item"><span>Window Bars:</span><span id="break_bars">£0.00</span></div>
        <div class="breakdown-item breakdown-total"><span>Unit Price (×1.3):</span><span id="break_unit">£0.00</span></div>
        <div class="breakdown-item"><span>Quantity:</span><span id="break_qty">1</span></div>
        <div class="breakdown-item breakdown-total"><span>Total Price:</span><span id="break_total">£0.00</span></div>
      </div>
    </div>

    <!-- RIGHT: Preview -->
    <div class="preview" style="min-width:360px;">
      <h2 class="section-title">Window Preview</h2>

      <!-- dynamic preview box (enlarges for design 11/12) -->
      <div id="previewBox" class="window-preview" role="img" aria-label="Window preview">
        <img id="preview-image" src="design1.png" alt="Window Preview" onerror="this.src='placeholder.png'">
      </div>

      <!-- zoom controls -->
      <div class="preview-controls">
        <button class="btn" id="zoomInBtn"><i class="fas fa-search-plus"></i></button>
        <button class="btn" id="zoomOutBtn"><i class="fas fa-search-minus"></i></button>
        <button class="btn" id="resetZoomBtn"><i class="fas fa-sync"></i></button>
      </div>

      <div style="text-align:center;margin-top:10px;">
        <div class="price-label">Estimated Price</div>
        <div id="mainPrice" style="font-size:28px;font-weight:700;margin-top:6px;">£0.00</div>
        <div id="errorMsg" style="margin-top:8px;font-size:13px;"></div>
      </div>

      <div class="details" style="margin-top:18px;">
        <p><i class="fas fa-info-circle"></i> Price includes VAT, delivery, and standard installation</p>
        <p><i class="fas fa-bolt"></i> Energy rating: A (U-value: 1.1W/m²K)</p>
        <p><i class="fas fa-paint-roller"></i> Finish: Internal & External RAL9016 White</p>
        <p><i class="fas fa-tree"></i> Timber: Engineered Pine with Sapele Sill</p>
        <p><i class="fas fa-expand"></i> Glass: 4mm/12 Argon/4mm Low-E</p>
      </div>
    </div>
  </div>

  <!-- REPORTS -->
  <div class="reports-section">
    <h2 class="section-title">Your Reports</h2>
    <div class="report-controls">
      <button class="add-report-btn btn" id="addReportBtn"><i class="fas fa-plus"></i> Add Current Configuration to Report</button>
      <div style="display:flex;gap:10px;">
        <button class="clear-reports-btn btn" id="clearReportsBtn"><i class="fas fa-trash"></i> Clear All Reports</button>
        <button class="download-all-btn btn" id="downloadAllBtn"><i class="fas fa-file-download"></i> Download All Reports (PDF)</button>
      </div>
    </div>

    <div class="reports-container" id="reportsContainer">
      <div class="no-reports" id="noReportsMessage">No reports added yet. Configure a window and click "Add to Report" to create your first report.</div>
    </div>

    <div class="grand-total" id="grandTotal">Grand Total: £0.00</div>
  </div>
</div>

<!-- ========== JavaScript ========== -->
<script>
/*
  Full rebuild script
  - All main functionality in one place
  - Comments explain each block
*/

/* ---------- Constants & state ---------- */

// Small feature-cost adjustments copied from your data
const featureCosts = {
  balance: { weights:0, spring:3.93, fixed:-86.26 },
  wood: { pine:0, sapele:221.91 },
  bars: { none:0, 'with-bars':213.39 }
};

// Reports storage (in-memory)
let reports = [];
let grandTotal = 0;

// Zoom state for preview image
let zoomLevel = 1;

/* ---------- Utility helpers ---------- */
function toInt(v){ return parseInt(v) || 0; }
function formatDate(d){
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yyyy = d.getFullYear();
  return dd + '/' + mm + '/' + yyyy;
}
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ---------- Validation rules ---------- */
/*
  - Max overall 2400mm
  - Designs 1-10: width 500-1400, height 1000-2500
  - Design 11: width 1500-2400, height 1500-2400
  - Design 12: width 1500-2400, height 1500-2400
*/
function validateSize(design, width, height){
  if (width > 2400 || height > 2400) return "Width and height cannot exceed 2400mm.";
  if (design >=1 && design <= 10) {
    if (width < 500 || width > 1400 || height < 1000 || height > 2500) return "Designs 1–10 require width 500–1400mm and height 1000–2500mm.";
    return "";
  }
  if (design === 11 || design === 12) {
    if (width < 1500 || width > 2400 || height < 1500 || height > 2400) return `Design ${design} requires width 1500–2400mm and height 1500–2400mm.`;
    return "";
  }
  return "";
}

/* ---------- UI toggles ---------- */
/* For Design 9, lock subtypes (balance/wood/bars) */
function toggleOptionsForDesign(design) {
  const balance = document.getElementById('balance');
  const wood = document.getElementById('wood');
  const bars = document.getElementById('bars');
  if (!balance || !wood || !bars) return;
  if (design === 9) {
    balance.disabled = true;
    wood.disabled = true;
    bars.disabled = true;
    balance.value = 'fixed';
    wood.value = 'pine';
    bars.value = 'none';
  } else {
    balance.disabled = false;
    wood.disabled = false;
    bars.disabled = false;
  }
}

/* Update size helper text */
function updateSizeHelp(design){
  const el = document.getElementById('sizeHelp');
  if (!el) return;
  if (design >=1 && design <=10) el.textContent = "Designs 1–10: width 500–1400mm, height 1000–2500mm.";
  else if (design === 11) el.textContent = "Design 11: width 1500–2400mm, height 1500–2400mm.";
  else if (design === 12) el.textContent = "Design 12: width 1500–2400mm, height 1500–2400mm.";
  else el.textContent = "Enter dimensions (max 2400mm).";
}

/* Human readable option text */
function getBalanceTypeText(v){ const map = { weights:'Traditional 147mm sash box with weights balance', spring:'Spring balance', fixed:'Fixed (No Opening)' }; return map[v]||v; }
function getWoodTypeText(v){ const map = { pine:'Engineered core wood PINE with hardwood SAPELE sill', sapele:'Full Hardwood SAPELE' }; return map[v]||v; }
function getBarsText(v){ const map = { none:'Not requested / no groove', 'with-bars':'22mm bars with spacer' }; return map[v]||v; }

/* ---------- Calculation logic ----------
   - Use base price from data-base-price attribute
   - adjustedPrice = (base + option adjustments) * sizeFactor
   - unitPrice = adjustedPrice * 1.3   <-- user requested multiplier
   - totalPrice = unitPrice * qty
*/
function calculatePrice(){
  const selected = document.querySelector('.design-item.selected');
  const errBox = document.getElementById('errorMsg');
  errBox.textContent = '';
  if (!selected) return null;

  const designId = toInt(selected.dataset.design);
  const basePrice = parseFloat(selected.dataset.basePrice) || 0;
  const width = toInt(document.getElementById('width').value);
  const height = toInt(document.getElementById('height').value);
  const qty = Math.max(1, toInt(document.getElementById('quantity').value));

  // Validate sizes
  const validationError = validateSize(designId, width, height);
  if (validationError) {
    errBox.textContent = validationError;
    errBox.style.color = '#a94442';
    document.getElementById('width').classList.add('invalid');
    document.getElementById('height').classList.add('invalid');

    // Reset breakdown
    document.getElementById('break_base').textContent = '£0.00';
    document.getElementById('break_size').textContent = '£0.00';
    document.getElementById('break_balance').textContent = '£0.00';
    document.getElementById('break_wood').textContent = '£0.00';
    document.getElementById('break_bars').textContent = '£0.00';
    document.getElementById('break_unit').textContent = '£0.00';
    document.getElementById('break_qty').textContent = qty;
    document.getElementById('break_total').textContent = '£0.00';
    document.getElementById('mainPrice').textContent = '£0.00';

    toggleOptionsForDesign(designId);
    return null;
  }

  // Valid -> apply calculations
  errBox.textContent = '✅ Size OK';
  errBox.style.color = '#2c7a34';
  document.getElementById('width').classList.remove('invalid');
  document.getElementById('height').classList.remove('invalid');

  toggleOptionsForDesign(designId);

  // Size factor (non-linear)
  const area = width * height;
  const refArea = 1000000;
  const sizeFactor = Math.pow(area / refArea, 0.8);

  // Option adjustments
  const balanceVal = document.getElementById('balance').value;
  const woodVal = document.getElementById('wood').value;
  const barsVal = document.getElementById('bars').value;

  const balanceAdj = featureCosts.balance[balanceVal] || 0;
  const woodAdj = featureCosts.wood[woodVal] || 0;
  const barsAdj = featureCosts.bars[barsVal] || 0;

  // adjusted price before multiplier
  const adjustedPrice = (basePrice + balanceAdj + woodAdj + barsAdj) * sizeFactor;

  // APPLY the requested ×1.3 multiplier to unit price
  const unitPrice = adjustedPrice * 1.3;

  // final total
  const totalPrice = unitPrice * qty;

  // Update breakdown DOM
  document.getElementById('break_base').textContent = '£' + basePrice.toFixed(2);
  document.getElementById('break_size').textContent = ((sizeFactor>1)?'+':'') + ((sizeFactor - 1) * 100).toFixed(1) + '%';
  document.getElementById('break_balance').textContent = balanceAdj !== 0 ? '£' + balanceAdj.toFixed(2) : '£0.00';
  document.getElementById('break_wood').textContent = woodAdj !== 0 ? '£' + woodAdj.toFixed(2) : '£0.00';
  document.getElementById('break_bars').textContent = barsAdj !== 0 ? '£' + barsAdj.toFixed(2) : '£0.00';
  document.getElementById('break_unit').textContent = '£' + unitPrice.toFixed(2);
  document.getElementById('break_qty').textContent = qty;
  document.getElementById('break_total').textContent = '£' + totalPrice.toFixed(2);

  document.getElementById('mainPrice').textContent = '£' + totalPrice.toFixed(2);

  // return values for reports
  return {
    designId, width, height, qty, balanceVal, woodVal, barsVal,
    basePrice, adjustedPrice, unitPrice, totalPrice
  };
}

/* ---------- Reports: add / remove / clear / render ---------- */

function recalcGrandTotal() {
  grandTotal = reports.reduce((s, r) => s + (r.totalPrice || 0), 0);
  document.getElementById('grandTotal').textContent = 'Grand Total: £' + grandTotal.toFixed(2);
}

/* Add current calculation as a report */
function addReport() {
  const calc = calculatePrice();
  if (!calc) {
    alert('Please fix validation errors before adding to report.');
    return;
  }

  const selected = document.querySelector('.design-item.selected');
  const designName = selected ? (selected.querySelector('.design-name') ? selected.querySelector('.design-name').textContent : ('Design ' + calc.designId)) : ('Design ' + calc.designId);
  const preview = selected && selected.dataset.preview ? selected.dataset.preview : 'placeholder.png';

  const report = {
    id: Date.now(),
    designId: calc.designId,
    designName,
    imageUrl: preview,
    balanceType: calc.balanceVal,
    woodType: calc.woodVal,
    bars: calc.barsVal,
    width: calc.width,
    height: calc.height,
    quantity: calc.qty,
    unitPrice: calc.unitPrice,
    totalPrice: calc.totalPrice
  };

  // append to reports
  reports.push(report);
  recalcGrandTotal();
  renderReports();

  // scroll to reports section as feedback
  document.querySelector('.reports-section').scrollIntoView({behavior:'smooth'});
}

/* Delete a single report by id */
function deleteReport(id) {
  const idx = reports.findIndex(r => r.id === id);
  if (idx === -1) return;
  if (!confirm('Delete this report?')) return;
  reports.splice(idx, 1);
  recalcGrandTotal();
  renderReports();
}

/* Clear all reports */
function clearReports() {
  if (reports.length === 0) return;
  if (!confirm('Clear all reports?')) return;
  reports = [];
  recalcGrandTotal();
  renderReports();
}

/* Render reports in the UI */
function renderReports() {
  const container = document.getElementById('reportsContainer');
  const noMsg = document.getElementById('noReportsMessage');
  container.innerHTML = '';

  if (reports.length === 0) {
    noMsg.style.display = 'block';
    document.getElementById('grandTotal').textContent = 'Grand Total: £0.00';
    return;
  }
  noMsg.style.display = 'none';

  reports.forEach(r => {
    const div = document.createElement('div');
    div.className = 'report';
    div.id = 'report-' + r.id;

    // Build inner HTML for report card (invoice-like summary + data)
    div.innerHTML = `
      <img src="${esc(r.imageUrl)}" alt="Design image" onerror="this.src='placeholder.png'">
      <div class="report-details">
        <h3>${esc(r.designName)}</h3>
        <p><strong>Window Size:</strong> ${r.width} mm x ${r.height} mm</p>
        <p><strong>Quantity:</strong> ${r.quantity}</p>
        <p><strong>Unit Price:</strong> £${r.unitPrice.toFixed(2)}</p>
        <p class="total-price"><strong>Total:</strong> £${r.totalPrice.toFixed(2)}</p>
        <p><strong>Profile:</strong> ${esc(getBalanceTypeText(r.balanceType))}</p>
        <p><strong>Timber:</strong> ${esc(getWoodTypeText(r.woodType))}</p>
        <p><strong>Finish:</strong> Internal/External RAL9016 White</p>
        <p><strong>Glass:</strong> 4mm / 12 argon / 4mm Low-E / 1.1W/m2K</p>
        <p><strong>Bars:</strong> ${esc(getBarsText(r.bars))}</p>

        <div class="report-actions">
          <button class="btn" style="background:#2b80d9;color:white;" onclick="downloadSingleReportPDF(${r.id})"><i class="fas fa-file-pdf"></i> Download PDF</button>
          <button class="btn" style="background:#e74c3c;color:white;" onclick="deleteReport(${r.id})"><i class="fas fa-trash"></i> Remove</button>
        </div>
      </div>
    `;
    container.appendChild(div);
  });

  // Update grand total
  document.getElementById('grandTotal').textContent = 'Grand Total: £' + grandTotal.toFixed(2);
}

/* ---------- PDF generation (via print window; works offline) ---------- */

/* Build HTML for a single report page (invoice-like) */
function buildSingleReportHTML(report) {
  const dateStr = formatDate(new Date());
  return `
    <div class="report-page" style="page-break-after:always;margin-bottom:24px;">
      <div style="text-align:center;margin-bottom:8px;">
        <h1 style="margin:0">Sash Window Configurator — Report</h1>
        <div style="color:#666;margin-top:6px;">Date: ${dateStr}</div>
      </div>
      <div style="display:flex;gap:12px;margin-top:12px;">
        <img src="${esc(report.imageUrl)}" style="width:200px;height:350px;object-fit:cover;border:1px solid #ddd" onerror="this.src='placeholder.png'">
        <div style="flex:1;">
          <h2 style="margin-top:0">${esc(report.designName)}</h2>
          <p><strong>Size:</strong> ${report.width} mm x ${report.height} mm</p>
          <p><strong>Quantity:</strong> ${report.quantity}</p>
          <p><strong>Unit Price (×1.3):</strong> £${report.unitPrice.toFixed(2)}</p>
          <p><strong>Total Price:</strong> £${report.totalPrice.toFixed(2)}</p>
          <p><strong>Profile:</strong> ${esc(getBalanceTypeText(report.balanceType))}</p>
          <p><strong>Timber:</strong> ${esc(getWoodTypeText(report.woodType))}</p>
          <p><strong>Finish:</strong> Internal/External RAL9016 White</p>
          <p><strong>Glass:</strong> 4mm / 12 argon / 4mm Low-E / 1.1W/m2K</p>
          <p><strong>Bars:</strong> ${esc(getBarsText(report.bars))}</p>
          <p><strong>Ironmongery:</strong> Lockable fastener, sash lifts & pulleys</p>
          <p><strong>Sill:</strong> Flush hardwood SAPELE</p>
          <p><strong>Board:</strong> Not requested / no groove</p>
          <p><strong>Ventilation:</strong> Not requested</p>
        </div>
      </div>
    </div>
  `;
}

/* Build combined HTML for all reports + summary table at the end */
function buildAllReportsHTML() {
  if (reports.length === 0) return '';
  const dateStr = formatDate(new Date());
  let pages = '';
  reports.forEach(r => pages += buildSingleReportHTML(r));

  // summary table rows
  let rows = '';
  reports.forEach((r,i) => {
    rows += `<tr>
      <td style="padding:6px;border:1px solid #ccc">${i+1}</td>
      <td style="padding:6px;border:1px solid #ccc">${esc(r.designName)}</td>
      <td style="padding:6px;border:1px solid #ccc">${r.width} x ${r.height}</td>
      <td style="padding:6px;border:1px solid #ccc">${r.quantity}</td>
      <td style="padding:6px;border:1px solid #ccc">£${r.unitPrice.toFixed(2)}</td>
      <td style="padding:6px;border:1px solid #ccc">£${r.totalPrice.toFixed(2)}</td>
    </tr>`;
  });

  rows += `<tr style="font-weight:bold">
    <td colspan="5" style="padding:6px;border:1px solid #ccc;text-align:right">Grand Total</td>
    <td style="padding:6px;border:1px solid #ccc">£${grandTotal.toFixed(2)}</td>
  </tr>`;

  const summary = `
    <div style="page-break-after:always;margin-bottom:24px;">
      <div style="text-align:center;margin-bottom:8px;">
        <h1 style="margin:0">Sash Window Configurator — Quote Summary</h1>
        <div style="color:#666;margin-top:6px;">Date: ${dateStr}</div>
      </div>
      <table style="width:100%;border-collapse:collapse;margin-top:12px;">
        <thead>
          <tr>
            <th style="padding:6px;border:1px solid #ccc">#</th>
            <th style="padding:6px;border:1px solid #ccc">Design</th>
            <th style="padding:6px;border:1px solid #ccc">Size</th>
            <th style="padding:6px;border:1px solid #ccc">Qty</th>
            <th style="padding:6px;border:1px solid #ccc">Unit Price</th>
            <th style="padding:6px;border:1px solid #ccc">Total</th>
          </tr>
        </thead>
        <tbody>
          ${rows}
        </tbody>
      </table>
      <div style="text-align:right;margin-top:12px;font-weight:bold">Grand Total: £${grandTotal.toFixed(2)}</div>
    </div>
  `;
  return pages + summary;
}

/* Open new window and trigger print (user can Save as PDF) */
function openPrintWindow(htmlContent) {
  const w = window.open('', '_blank', 'toolbar=0,location=0,menubar=0');
  if (!w) { alert('Popup blocked. Allow popups for this site to download PDFs.'); return; }
  const style = `<style>
    body{font-family:Arial,Helvetica,sans-serif;color:#222;margin:20px;}
    .report-page{page-break-after:always;margin-bottom:18px;}
    img{max-width:100%;}
  </style>`;
  w.document.open();
  w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Reports</title>${style}</head><body>${htmlContent}</body></html>`);
  w.document.close();
  w.onload = function(){ setTimeout(()=>{ w.focus(); w.print(); }, 350); };
}

/* Download single report PDF (print) */
function downloadSingleReportPDF(reportId) {
  const rep = reports.find(r => r.id === reportId);
  if (!rep) { alert('Report not found'); return; }
  const html = buildSingleReportHTML(rep);
  openPrintWindow(html);
}

/* Download all reports as multi-page PDF (print) */
function downloadAllReportsPDF() {
  if (reports.length === 0) { alert('No reports to export'); return; }
  const html = buildAllReportsHTML();
  openPrintWindow(html);
}

/* ---------- Preview zoom ---------- */
function updateImageZoom() {
  const img = document.getElementById('preview-image');
  img.style.transform = `scale(${zoomLevel})`;
}

/* ---------- Wiring: event listeners & initial setup ---------- */
document.addEventListener('DOMContentLoaded', function() {
  // initial variables
  reports = [];
  grandTotal = 0;
  zoomLevel = 1;

  // Design selection click handlers
  document.querySelectorAll('.design-item').forEach(item => {
    item.addEventListener('click', function() {
      // mark selected visually
      document.querySelectorAll('.design-item').forEach(i => i.classList.remove('selected'));
      this.classList.add('selected');

      // preview logic: enlarge for design 11/12
      const designId = toInt(this.dataset.design);
      const previewSrc = this.dataset.preview || 'placeholder.png';
      const previewBox = document.getElementById('previewBox');
      const previewImg = document.getElementById('preview-image');

      if (designId === 11 || designId === 12) {
        previewBox.style.width = '400px';
        previewBox.style.height = '300px';
        previewBox.style.background = '#6c8a99';
      } else {
        previewBox.style.width = '320px';
        previewBox.style.height = '240px';
        previewBox.style.background = '#8fb0bf';
      }

      // update image & reset zoom
      previewImg.src = previewSrc;
      zoomLevel = 1; updateImageZoom();

      // update helper & options
      updateSizeHelp(designId);
      toggleOptionsForDesign(designId);

      // recalc price for immediate feedback
      calculatePrice();
    });
  });

  // Input change handlers (live calculate)
  ['width','height','quantity'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('input', calculatePrice);
  });
  ['balance','wood','bars'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('change', calculatePrice);
  });

  // Buttons
  document.getElementById('calcBtn').addEventListener('click', function(e){ e.preventDefault(); calculatePrice(); });
  document.getElementById('addReportBtn').addEventListener('click', addReport);
  document.getElementById('clearReportsBtn').addEventListener('click', clearReports);
  document.getElementById('downloadAllBtn').addEventListener('click', downloadAllReportsPDF);

  // Zoom controls
  document.getElementById('zoomInBtn').addEventListener('click', ()=>{ zoomLevel = Math.min(2, zoomLevel + 0.1); updateImageZoom(); });
  document.getElementById('zoomOutBtn').addEventListener('click', ()=>{ zoomLevel = Math.max(0.5, zoomLevel - 0.1); updateImageZoom(); });
  document.getElementById('resetZoomBtn').addEventListener('click', ()=>{ zoomLevel = 1; updateImageZoom(); });

  // initial selection / preview
  const initiallySelected = document.querySelector('.design-item.selected') || document.querySelector('.design-item');
  if (initiallySelected) {
    const designId = toInt(initiallySelected.dataset.design);
    const preview = initiallySelected.dataset.preview || 'placeholder.png';
    document.getElementById('preview-image').src = preview;
    updateSizeHelp(designId);
    toggleOptionsForDesign(designId);
  }

  // initial calculation
  calculatePrice();
});
</script>
</body>
</html>
